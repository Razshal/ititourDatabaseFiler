<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Remplisseur de base de données</title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.js"
            integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
            crossorigin="anonymous"></script>
    <style>
        body{
            margin:0;
            width:100%;
        }
        html{
            font-family: Arial, Helvetica, sans-serif;
            margin:0;
            width:100%;
        }
        #chat{
            height: 60vh;
            width: auto;
            overflow:auto;
            background-color: darkgray;
            font-size : 100%;
            margin-bottom: 20px;
            border-radius : 10px;
            resize: both;
        }

        .datasFromDatabase, .log, .post, #advices{
            display: inline-flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: stretch;
            align-items: flex-start;
        }
        .datasFromDatabaseType{
            list-style-type: none;
            text-decoration: none;
            text-align: center;
            font-size: 120%;
        }

        .post{
            color: white;
            background-color: coral;
            border: 2px solid white;
            border-radius: 10px;
            text-align: center;
            min-height:30px;
            line-height: 30px;
            width: 40vw;
            margin-left: auto;
            margin-right: auto;
        }
        .log{
            position: relative;
            color: #a60000;
            font-size: 120%;
            border : 2px solid black;
            border-radius: 10px;
            background-color: white;
            padding: 5px;
            line-height: 8vh;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        .datasFromDatabase{
            border: 2px solid;
            border-radius: 10px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 15px;
            list-style-type: none;
            padding-left: 0;
            position: relative;
        }
        .suppress{
            cursor: pointer;
            position: absolute;
            top:0;
            right:0;
            border-top-right-radius: 10px;
            height:4vh;
            width: 50px;
            background-color: #c90000;
            text-align: center;
            line-height: 4vh;
            z-index: +5;
        }
        .suppress:after{
            content: 'X';
        }
        input[type="text"], input[type="number"], input[type="password"], #desc{
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            border: none;
            background-color: #e8eef0;
            color: black;
            resize:both;
        }

        input[type="radio"]{
            min-height: 16px;
            min-width: 16px;
        }

        #name,#note,#keywords,#villagesList, #sitesList,
        #desc,#send,#advices, #linkedDepartement, #linkedVille{
            display: none;
        }

        #send, #advicesButton {
            margin: 10px;
        }
        #send:hover, #advicesButton:hover {
            background-color: white;
            color: black;
            border: 2px solid #555555;
        }

        #advices, h1, .datasFromDatabase, #send, #advicesButton {
            color: #e7e7e7;
            background-color: dimgray;
        }

        #advices{
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: #7d766b;
        }
        li{
            margin-top: 5px;
        }
        h1{
            margin:0;
            text-align: center;
            width:100%;
            display: block;
            background-color: dimgray;
            padding: 10px 0 10px 0;
        }
        h2{
            display: inline;
            position: inherit;
        }
        h4{
            z-index: 0;
            height:4vh;
            line-height: 4vh;
            margin: 0;
            position: absolute;
            width: 100%;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            background-color: lightslategray;
        }
        button{
            min-height: 30px;
            border: none;
        }
        ul{
            margin-top: 40px;
        }
        li{
            margin-left: 10px;
        }

    </style>
</head>
    <body>
        <h1>Ititour : Interface d'administration du contenu</h1>
        <h2>Test v0.3.2</h2>
        <input type="password" id="password" placeholder="Mot de passe d'accès au serveur">

        <form id="dataType" action ="">
            <input name ="type" type="radio" id="isDepartement" class="css-checkbox" class="dark-check-cyan">Département
            <input name ="type" type="radio" id="isVille">Ville/Village
            <input name ="type" type="radio" id="isSite">Site touristique
        </form>

        <form class="datasForm">
            <input type="text" placeholder="Le nom du departement/village/site" id="name">
            <input type="text" placeholder="Le nom du département où se situe cette ville/village" id="linkedDepartement">
            <input type="text" placeholder="Le nom de la ville où se situe ce site touristique" id="linkedVille">
            <input type="number" placeholder="Note de 0 à 5" id="note">
            <input type="text" placeholder="Mots clés (chaque mot clé doit être séparé par une virgule)" id="keywords">
            <input type="text" placeholder="Liste des villes et villages du département séparés par une virgule" id="villagesList">
            <input type="text" placeholder="Liste des sites touristiques de la ville/village séparés par une virgule" id="sitesList">
            <textarea id="desc" placeholder="Description de l'élément"></textarea>
            <button id="send">Envoyer directement dans la base de données</button>
        </form>

        <button id="advicesButton">Afficher la notice d'utilisation</button>
        <div id="advices">
            <h3>Bienvenue sur l'outil de remplissage de la base de données d'Ititour</h3>
            <ul>
                <li>Il est impératif de ne faire aucune faute sur aucun mot et de conserver la même orthographe majuscule et tirets compris pour chaque nom que vous utiliserez</li>
                <li>L'autre gros cadre gris en dessous vous montre les dernières données qui ont été rentrées, elles sont brutes,
                telles qu'affichées dans la base de données, ne faites pas attention à leur mise en forme car le programme se permet
                quelques libertés, vous pouvez par contre controler grace à ça les majuscules et fautes d'orthographe</li>
                <li>La base de données va automatiquement associer les sites touristiques que vous entrerez dans
                les villes/villages mais pour celà il est nécéssaire que vous entriez le nom des sites avec la même orthographe
                même chose pour les villes dans la rubrique département</li>
                <li>Il n'y a aucune importance dans l'odre dans lequel vous entrez les données tant que le site web n'est pas en ligne</li>
                <li>Un site touristique peut être une cathédrale, un pont, un panorama, etc un point d'interrêt que vous souhaitez traiter</li>
                <li>Il faut décocher la case actuelle si vous voullez en choisir une autre</li>
            </ul>
        </div>
        <div id="chat"></div>
    </body>
</html>


<script>
    var form = {descField: document.getElementById('desc'),
        nameField: document.getElementById('name'),
        linkedDepartementField: document.getElementById('linkedDepartement'),
        linkedVilleField: document.getElementById('linkedVille'),
        noteField : document.getElementById('note'),
        keywordsField : document.getElementById('keywords'),
        villesListField : document.getElementById('villagesList'),
        sitesListField : document.getElementById('sitesList'),
        send : document.getElementById('send')
    };
    var passwordField = document.getElementById('password');

    var dataTypeCheckboxes = document.getElementById('dataType');
    var isDepartement = document.getElementById('isDepartement');
    var isVille = document.getElementById('isVille');
    var isSite = document.getElementById('isSite');

    var advicesButton = document.getElementById('advicesButton');
    var advices = document.getElementById('advices');
    var chat = document.getElementById('chat');

    var server = ('192.168.0.32:8080');
    var socket = io.connect(server);

    String.prototype.capitalizeFirstLetter = function() {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };

    Array.prototype.fieldDataCorrectAfterSplit = function(){
        $.trim(this);
        for (var thing in this){
            this[thing] = $.trim(this[thing]);
            this[thing] = this[thing].capitalizeFirstLetter();
        }
        return this;
    };

    function pageScroll() {
        chat.scrollTop = chat.scrollHeight;
    }

    function postToChat(data){
        var parag = document.createElement("p");
        parag.classList.add('post');
        parag.appendChild(document.createTextNode(data));
        chat.appendChild(parag);
        pageScroll();
    }
    function postLogToChat(data){
        var parag = document.createElement("p");
        parag.classList.add('log');
        parag.appendChild(document.createTextNode(data));
        chat.appendChild(parag);
        pageScroll();
    }
    function convertToArrayAndCorrectData(something) {
        if (something) {
            var something = something;
            something = something.split(",");
            something.fieldDataCorrectAfterSplit();
            return something;
        }
    }


    function postDatasIntoChat(data){
        /* On récupère les données que le serveur nous envoie, on les filtre puis on les poste dans le "chat"
        *  avec le serveur
        */
        console.log("Datas : " + data.datas.type);
            for (dataFromDb in data.datas) {
                var div = document.createElement("div");
                var parag = document.createElement("ul");
                var suppressButton = document.createElement("a");
                var title = document.createElement("h4");

                suppressButton.classList.add("suppress");
                div.classList.add('datasFromDatabase');
                title.classList.add("datasFromDatabaseType");

                //On vérifie que cet élément ne soit pas déjà présent sur la page avant de lui donner l'id de l'objet
                if (!document.getElementById(data.datas[dataFromDb]._id)) {
                    div.id = data.datas[dataFromDb]._id;
                    suppressButton.classList.add(data.datas[dataFromDb]._id);

                    suppressButton.addEventListener('click', function (e) {
                        var confirm = (window.confirm('Voullez vous réllement supprimer cette entrée ? Cette action est irreversible'));
                        if (confirm) {
                            var id = (e.target.className.split(" ")[1]).toString();
                            socket.emit('askForDeletion', {
                                password: passwordField.value,
                                id:id
                            });
                        }
                    });
                }
                for (var subArray in data.datas[dataFromDb]) {

                    if (subArray.toString() == "_id" || subArray.toString() == "date"
                            || subArray.toString() == "__proto__" || data.datas[dataFromDb][subArray] == undefined)
                            continue;

                    if(subArray.toString() == "type") {
                        title.appendChild(document.createTextNode(data.datas[dataFromDb][subArray]));

                    }
                    else {
                        var datasIntoChat = document.createElement("li");
                        datasIntoChat.appendChild(document.createTextNode(`${subArray.toString()} : ${data.datas[dataFromDb][subArray]}`));
                    }
                    if(datasIntoChat) parag.appendChild(datasIntoChat);

                    div.appendChild(title);
                    div.appendChild(suppressButton);
                    div.appendChild(parag);
                }
                if(data.datas[dataFromDb]._id != undefined)
                    chat.appendChild(div);
            }
        pageScroll();
    }

    function pushIntoDatabase(name, note, keywords, desc, sites,
                              villes, departement, linkedVille){
        if (parseInt(note) && name && desc) {
            var note = parseInt(note);

            keywords = convertToArrayAndCorrectData(keywords);
            villes = convertToArrayAndCorrectData(villes);
            sites = convertToArrayAndCorrectData(sites);
            var type = isDepartement.checked ? "Departement" : isVille.checked ? "Ville" : isSite.checked ? "Site" : undefined;
            var password = passwordField.value.toString();

            if (isSite.checked) {
                socket.emit('datasToPush', {
                    password, type, name,
                     note, keywords,
                    linkedVille, desc
                });
                postToChat("Envoi du site");
            }
            if (isVille.checked) {
                socket.emit('datasToPush', {
                    password, type, name,
                    note, keywords,
                    departement, sites, desc
                });
                postToChat("Envoi de la ville");
            }
            if (isDepartement.checked) {
                socket.emit('datasToPush', {
                    password, type, name,
                    note, keywords,
                    villes, desc
                });
                postToChat("Envoi du departement");
            }
        }
        else
            postLogToChat("Erreur dans les données renseignées ou le mot de passe, annulation de l'envoi en base de données")
    }

// ----------------- Here starts the "loop" -----------------

    socket.on('lastDatas', function (data) {
        postDatasIntoChat(data);
    });

    socket.on('logForApp', function(data){
        console.log(`Socket reçu`);
        postLogToChat(data.err);
    });

    socket.on('confirmation', function (data) {
        if (data.confirmationType == "deletion"){
            document.getElementById(data.dataId.toString()).remove();
            console.log(data.dataId);
        }
    });

    dataTypeCheckboxes.addEventListener('click', function () {
        isDepartement.checked || isVille.checked || isSite.checked ?
         (form.nameField.style.display = "inline", form.noteField.style.display = "inline", form.descField.style.display = "inline") : function () {
            for (var element in form){
                form[element].style.display ="none";
            }
        };

        if (isDepartement.checked){
            form.villesListField.style.display = "inline";
            form.keywordsField.style.display = "none";
            form.sitesListField.style.display = "none";
            form.linkedDepartementField.style.display = "none";
            form.linkedVilleField.style.display = "none";
            form.send.style.display = "inline";

        }
        else if (isVille.checked){
            form.linkedDepartementField.style.display = "inline";
            form.linkedVilleField.style.display = "none";
            form.villesListField.style.display = "none";
            form.keywordsField.style.display = "inline";
            form.sitesListField.style.display = "inline";
            form.send.style.display = "inline";

        }
        else if (isSite.checked){
            form.villesListField.style.display = "none";
            form.keywordsField.style.display = "inline";
            form.sitesListField.style.display = "none";
            form.linkedDepartementField.style.display = "none";
            form.linkedVilleField.style.display = "inline";
            form.send.style.display = "inline";

        }
    });

    var isAdviceDisplayed = false;

    advicesButton.addEventListener('click', function (e) {
        e.preventDefault();
        isAdviceDisplayed = !isAdviceDisplayed;
        isAdviceDisplayed ? advices.style.display = "inline-block" : advices.style.display = "none";
    });
    form.send.addEventListener('click', function(e){
        e.preventDefault();
        pushIntoDatabase(form.nameField.value, form.noteField.value, form.keywordsField.value,
               form.descField.value, form.sitesListField.value, form.villesListField.value,
               form.linkedDepartementField.value, form.linkedVilleField.value);
    });




</script>